<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>射水市 飲食店検索 (多機能版)</title>
    <style>
        body{font-family:sans-serif;margin:2em;background-color:#f9f9f9}
        .container{max-width:800px;margin:auto;background:white;padding:20px;border-radius:8px;box-shadow:0 0 10px #ddd}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1em}
        .user-controls button{margin-left:10px}
        .restaurant-item{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee}
        .modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
        .modal-content{background-color:#fefefe;margin:10% auto;padding:20px;width:80%;max-width:500px;border-radius:8px}
        .close-btn{float:right;font-size:28px;font-weight:700;cursor:pointer}
        .review-item{padding:8px 0;border-bottom:1px solid #eee}.review-item small{color:#888}
        .delete-btn{color:red;border:none;background:0 0;cursor:pointer;margin-left:10px;display:none}
        .admin-mode .delete-btn{display:inline}
    </style>
</head>
<body id="page-body">
    <div class="container">
        <div class="header">
            <h1>射水市 飲食店検索</h1>
            <div class="user-controls">
                <span id="user-display">未ログイン</span>
                <button id="login-btn">ログイン</button>
                <button id="history-btn" style="display:none;">閲覧履歴</button>
                <button id="logout-btn" style="display:none;">ログアウト</button>
            </div>
        </div>
        <ul id="restaurant-list" class="restaurant-list"></ul>
    </div>
    
    <footer><p style="text-align:center;color:#aaa"><span id="admin-trigger" style="cursor:pointer;">©</span></p></footer>

    <div id="main-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title"></h2><div id="modal-body"></div>
        </div>
    </div>

<script>
    const allRestaurants = [
        { id: "r001", name: "きときと食堂" }, { id: "r002", name: "meso" }, { id: "r009", name: "隠れ家居酒屋 海彩" },
        { id: "r014", name: "中華そばげんじ" }, { id: "r019", name: "番やのすし 小杉店" }, { id: "r024", name: "Café de Repos" }
    ];

    let currentUser = null;
    let isAdmin = false;

    // --- 要素取得 ---
    const restaurantListEl = document.getElementById('restaurant-list');
    const modal = document.getElementById('main-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const userDisplay = document.getElementById('user-display');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const historyBtn = document.getElementById('history-btn');
    const adminTrigger = document.getElementById('admin-trigger');
    const pageBody = document.getElementById('page-body');

    // --- イベントリスナー ---
    document.addEventListener('DOMContentLoaded', updateUI);
    document.querySelector('.close-btn').onclick = () => modal.style.display = 'none';
    loginBtn.onclick = login;
    logoutBtn.onclick = logout;
    historyBtn.onclick = showHistory;
    adminTrigger.onclick = enterAdminMode;

    // --- UI制御 ---
    function updateUI() {
        if (currentUser) {
            userDisplay.textContent = `${currentUser}としてログイン中` + (isAdmin ? " (管理者)" : "");
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            historyBtn.style.display = 'inline-block';
        } else {
            userDisplay.textContent = '未ログイン';
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            historyBtn.style.display = 'none';
        }
        pageBody.classList.toggle('admin-mode', isAdmin);
        renderList();
    }

    // --- 機能 ---
    function login() {
        const username = prompt("ユーザー名を入力してください:");
        if (username) {
            currentUser = username.trim();
            updateUI();
        }
    }

    function logout() {
        currentUser = null;
        isAdmin = false;
        updateUI();
    }
    
    function enterAdminMode() {
        const pass = prompt("管理者パスワードを入力してください:");
        if (pass === "admin123") { // ★実際のアプリでは絶対に使わない簡易パスワード
            isAdmin = true;
            if (!currentUser) login(); else updateUI();
            alert("管理者モードになりました。");
        } else {
            alert("パスワードが違います。");
        }
    }

    async function showDetails(id, name) {
        if (currentUser) {
            await fetch(`/api/history/${currentUser}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ restaurantId: id, restaurantName: name })
            });
        }
        window.open(`https://www.google.com/search?q=${encodeURIComponent(name + " 射水市")}`, '_blank');
    }

    async function showHistory() {
        const res = await fetch(`/api/history/${currentUser}`);
        const history = await res.json();
        modalTitle.textContent = `${currentUser}の閲覧履歴`;
        let body = '<ul>';
        if (history.length > 0) {
            history.forEach(item => {
                body += `<li>${item.name} <small>(${new Date(item.viewedAt).toLocaleString()})</small></li>`;
            });
        } else {
            body += '<li>閲覧履歴はありません。</li>';
        }
        body += '</ul>';
        if (isAdmin) {
            body += `<button class="delete-btn" style="display:inline-block" onclick="clearHistory('${currentUser}')">このユーザーの履歴を全て削除</button>`;
        }
        modalBody.innerHTML = body;
        modal.style.display = 'block';
    }
    
    async function clearHistory(username) {
        if (confirm(`${username}の履歴を全て削除します。よろしいですか？`)) {
            await fetch(`/api/history/${username}`, { method: 'DELETE' });
            modal.style.display = 'none';
        }
    }

    async function showReviews(id, name) {
        const res = await fetch(`/api/reviews/${id}`);
        const reviews = await res.json();
        modalTitle.textContent = `${name} の口コミ`;
        let body = '<div>';
        reviews.forEach(r => {
            body += `<div class="review-item"><p><strong>${r.username}:</strong> ${r.text}</p><small>${new Date(r.timestamp).toLocaleString()}</small><button class="delete-btn" onclick="deleteReview('${id}','${name}','${r.timestamp}')">削除</button></div>`;
        });
        body += `</div><form onsubmit="submitReview(event, '${id}', '${name}')">
            <textarea placeholder="${currentUser ? '口コミを投稿する...' : 'ログインしてください'}"></textarea>
            <button type="submit" ${!currentUser ? 'disabled' : ''}>投稿</button>
            </form>`;
        modalBody.innerHTML = body;
        modal.style.display = 'block';
    }

    async function submitReview(event, id, name) {
        event.preventDefault();
        const text = event.target.querySelector('textarea').value;
        if (!text) return;
        await fetch(`/api/reviews/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: currentUser, text: text })
        });
        showReviews(id, name);
    }
    
    async function deleteReview(id, name, timestamp) {
        if (confirm("この口コミを削除しますか？")) {
            await fetch(`/api/reviews/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timestamp: timestamp })
            });
            showReviews(id, name);
        }
    }

    function renderList() {
        restaurantListEl.innerHTML = '';
        allRestaurants.forEach(r => {
            const li = document.createElement('li');
            li.className = 'restaurant-item';
            li.innerHTML = `<span>${r.name}</span><div>
                <button onclick="showReviews('${r.id}', '${r.name}')">口コミ</button>
                <button onclick="showDetails('${r.id}', '${r.name}')">詳細</button>
                </div>`;
            restaurantListEl.appendChild(li);
        });
    }
</script>
</body>
</html>